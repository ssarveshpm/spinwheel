<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahalo team!</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath d='M0 256a256 256 0 1 1 512 0 256 256 0 1 1 -512 0zm256 32a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm-96-32a96 96 0 1 0 192 0 96 96 0 1 0 -192 0zm-56-16c0-32.4 16.3-66.6 42.8-93.2S207.6 104 240 104c13.3 0 24-10.7 24-24s-10.7-24-24-24c-47.9 0-93.7 23.5-127.1 56.9S56 192.1 56 240c0 13.3 10.7 24 24 24s24-10.7 24-24z'/%3E%3C/svg%3E">
    <!-- Modern Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* Modern CSS Reset & Variables */
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f1c40f;
            --text-dark: #2d3748;
            --text-light: #718096;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            padding: 30px;
            /* Reduced padding for narrower width */
            max-width: 350px;
            /* Even Narrower default width */
            width: 95%;
            text-align: center;
            animation: slideUp 0.6s ease-out;
            transform: translateY(0);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: max-width 0.5s ease;
        }

        .container.wide-mode {
            max-width: 900px;
            /* Wide mode remains same */
            padding: 15px 50px;
            /* Reduced vertical padding drastically */
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        h2 {
            color: var(--text-dark);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            background: #f7fafc;
            outline: none;
        }

        input[type="text"]:focus,
        input[type="email"]:focus {
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
            font-family: 'Poppins', sans-serif;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.2), 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .wheel-container {
            position: relative;
            width: 280px;
            /* Increased to fit slider */
            height: 280px;
            margin: 20px auto;
            border-radius: 50%;
            padding: 15px;
            background: #222;
            /* Darker rim */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            display: none;
            /* Hidden by default */
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#f1c40f 0deg 30deg,
                    #333 30deg 60deg,
                    #f1c40f 60deg 90deg,
                    #333 90deg 120deg,
                    #f1c40f 120deg 150deg,
                    #333 150deg 180deg,
                    #f1c40f 180deg 210deg,
                    #333 210deg 240deg,
                    #f1c40f 240deg 270deg,
                    #333 270deg 300deg,
                    #f1c40f 300deg 330deg,
                    #333 330deg 360deg);
            transition: transform 2s cubic-bezier(0.2, 0.8, 0.3, 1);
            position: relative;
            z-index: 1;
        }

        /* Circular Slider Styles */
        .slider-track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.2);
            pointer-events: none;
            z-index: 0;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.5);
        }

        .slider-handle {
            position: absolute;
            width: 50px;
            height: 60px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="60" viewBox="0 0 50 60"><path d="M25 60 L2 5 L48 5 Z" fill="red" stroke="black" stroke-width="3"/></svg>');
            background-repeat: no-repeat;
            background-size: contain;
            top: calc(50% - 30px);
            left: calc(50% - 25px);
            cursor: grab;
            z-index: 10;
            transition: transform 0.1s ease;
            user-select: none;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .slider-handle:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .slider-handle::after {
            content: '';
        }

        .slider-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
            display: none;
            mask-image: radial-gradient(transparent 132px, black 133px);
            -webkit-mask-image: radial-gradient(transparent 132px, black 133px);
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .marker {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #e74c3c;
            z-index: 3;
        }

        @keyframes spin-wheel {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(3600deg);
            }
        }

        .spinning {
            animation: spin-wheel 6s linear infinite;
        }

        .spinner-hidden {
            display: none;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1em;
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }

        .message.show {
            display: block;
        }

        .message.error {
            background-color: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }

        .message.success {
            background-color: #efe;
            color: #3c3;
            border: 2px solid #cfc;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .thank-you-screen {
            text-align: center;
            padding: 10px 20px;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .thank-you-screen h2 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 20px;
        }

        .thank-you-screen p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }

        .thank-you-icon {
            font-size: 5em;
            margin-bottom: 20px;
            display: block;
        }

        /* Welcome Section Styles */
        .welcome-section {
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }

        .welcome-section h2 {
            font-size: 2.2em;
            color: #333;
            margin-bottom: 20px;
        }

        /* New helper to target paragraphs in welcome section specifically if needed, 
           or we can just use the wide container to let text flow. */
        .welcome-section p {
            max-width: 100% !important;
            /* Override inline styles */
            margin-bottom: 10px !important;
        }

        .welcome-steps {
            text-align: left;
            margin: 10px auto;
            max-width: 100%;
            /* Use full width */
            color: #555;
            font-size: 1rem;
            /* Normalized to standard size */
            line-height: 1.5;
            /* Tighter line height */
        }

        .welcome-steps li {
            margin-bottom: 10px;
        }

        .start-btn {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: #333;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container wide-mode" id="mainContainer">
        <!-- Welcome Section -->
        <div id="welcomeSection" class="welcome-section">
            <span style="font-size: 4em; display: block; margin-bottom: 10px;">ðŸŽ‰</span>
            <h2>Mahalo team!</h2>
            <p style="text-align: left; max-width: 80%; margin: 0 auto 15px auto; color: #555;">
                It's the end of the year and a good time to reflect on the good times we have had working together. So,
                here's a little something from me as a colleague who values your support. You may want to use it for
                your next coffee break or however you'd like it :)

            </p>
            <p style="text-align: left; max-width: 80%; margin: 0 auto 15px auto; color: #555;">
                Wanted to keep it as a fun activity - Spin a wheel and an assured treat awaits you!
            </p>
            <p style=" margin-top: 25px; margin-bottom: 10px; text-align: left;">All you need to do is : </p>
            <ul class="welcome-steps">
                <li>Collect a <strong>Spin Token</strong> from Vinesh.</li>
                <li>Fill in your details in the form.</li>
                <li>Spin to see your lucky win!</li>
            </ul>
            <p style="margin-top: 30px; text-align: left; color: #555;">I canâ€™t wait to see what
                everyone gets!</p>
            <p style="text-align: left; color: #555; padding-bottom: 10px;">Cheers,<br>Sarvesh S</p>
            <button id="getStartedBtn" class="start-btn">Get Started</button>
        </div>

        <!-- Validation Section (Hidden initially) -->
        <div id="validationSection" style="display: none;">
            <h1 id="validationTitle">ðŸŽ« Token Validator</h1>
            <form id="voucherForm">
                <div class="form-group">
                    <label for="voucherId">Spin Token</label>
                    <input type="text" id="voucherId" name="voucherId" placeholder="Enter your token" autocomplete="off"
                        required />
                </div>
                <button type="submit" id="submitBtn">Open Sesame</button>
            </form>

            <form id="detailsForm" style="display: none;">
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" placeholder="Enter your name" autocomplete="name"
                        required />
                </div>
                <div class="form-group">
                    <label for="email">Cardy or PB Email</label>
                    <input type="email" id="email" name="email" placeholder="Enter your email ID" autocomplete="email"
                        required />
                </div>
                <div class="form-group">
                    <label for="mobile">Mobile Number</label>
                    <input type="text" id="mobile" name="mobile" placeholder="Enter Mobile Number" required />
                </div>
                <div class="form-group">
                    <label for="preference">Treat Preference</label>
                    <select id="preference" name="preference" required
                        style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; font-family: 'Poppins', sans-serif; background: #f7fafc; outline: none;">
                        <option value="" disabled selected>Select your preference</option>
                        <option value="EatSure">EatSure (Faasos, Behrouz Biryani, OvenStory, Sweet Truth etc)</option>
                        <option value="Dominos">Dominos</option>
                        <option value="BigBasket">BigBasket</option>
                        <option value="JioMart">JioMart</option>
                    </select>
                </div>
                <!-- Redemption Steps Container -->
                <div id="redemptionSection"
                    style="display: none; text-align: left; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; animation: fadeIn 0.3s ease;">
                    <h4 style="font-size: 0.95rem; margin-bottom: 8px; color: #4a5568;">How to redeem?</h4>
                    <ul id="redemptionSteps"
                        style="font-size: 0.85rem; color: #718096; padding-left: 20px; line-height: 1.6;">
                    </ul>
                </div>
                <button type="submit" id="submitDetailsBtn">Submit</button>
            </form>

            <div id="message" class="message"></div>
        </div>

        <div id="thankYouScreen" class="thank-you-screen">
            <div id="amountSection">
                <!-- Wheel Structure -->
                <div id="wheelContainer" class="wheel-container">
                    <div class="slider-track"></div>
                    <div id="sliderProgress" class="slider-progress"></div>
                    <div class="marker"></div>
                    <div id="wheel" class="wheel"></div>
                    <div id="wheelCenter" class="wheel-center">Drag to Spin</div>
                    <div id="sliderHandle" class="slider-handle"></div>
                </div>

                <p id="prankMessage"
                    style="display: none; color: #e74c3c; margin-top: 10px; font-weight: 700; font-size: 1.25em; background: #fff5f5; padding: 15px; border-radius: 12px; border: 2px dashed #ffcdd2;">
                    lol just kidding! ðŸ˜œ This was a warm-up spin. Spin Again!
                </p>

                <p id="finalMessage"
                    style="display: none; color: #2ecc71; margin-top: 10px; font-weight: 600; font-size: 1.1em; background: #f0fff4; padding: 15px; border-radius: 12px; border: 2px solid #c6f6d5;">
                    Congratulations! Expect to receive your gift card by the end of the week.
                </p>

                <p id="supportMessage"
                    style="display: none; color: #555; margin-top: 20px; font-style: italic; line-height: 1.6; border-top: 1px solid #eee; padding-top: 15px;">
                    Thank you once again for the incredible support this year. Looking forward to the same energy,
                    teamwork, and collaboration in the year ahead.
                </p>
            </div>

        </div>



        <script>
            // IMPORTANT: Replace this URL with your Google Apps Script Web App URL
            // After deploying your Apps Script, you'll get a URL like:
            // https://script.google.com/macros/s/AKfycby.../exec
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkyxaFeNMOovmxFb1R0QMQ4SJQ8Qi3IQBBR7F3CVIpWDJdCANqdFf427XFaTbLQiuY/exec';

            const form = document.getElementById('voucherForm');
            const detailsForm = document.getElementById('detailsForm');

            // New Sections
            const validationSection = document.getElementById('validationSection');
            const welcomeSection = document.getElementById('welcomeSection');
            const getStartedBtn = document.getElementById('getStartedBtn');

            const thankYouScreen = document.getElementById('thankYouScreen');
            const amountDisplay = document.getElementById('wheelCenter'); // Re-purpose for center text
            const wheelContainer = document.getElementById('wheelContainer');
            const wheel = document.getElementById('wheel');
            const prankMessage = document.getElementById('prankMessage');
            const finalMessage = document.getElementById('finalMessage');
            const supportMessage = document.getElementById('supportMessage');
            const preferenceSelect = document.getElementById('preference');
            const redemptionSection = document.getElementById('redemptionSection');
            const redemptionSteps = document.getElementById('redemptionSteps');

            const redemptionData = {
                'JioMart': [
                    'Log on to JioMart application on your mobile.',
                    'Select the products of your choice and add them to the cart.',
                    'Move to the checkout page and select Add Gift Card/ Voucher Code.',
                    'Enter the 16 digit Voucher code and redeem the Voucher.'
                ],
                'Dominos': [
                    'Log on to Dominos App and Website.',
                    'Add the items in the cart and proceed to checkout.',
                    'Click on E Vouchers Tab to add the Gift Cards. Enter Gift Card number and PIN and click on submit.'
                ],
                'BigBasket': [
                    'Gift Card can be used on Bigbasket App and M-site where Bigbasket is present.',
                    'Go to My Gift Cards under my account section',
                    'Enter your Gift Card Code and Gift Card PIN',
                    'The value of the Gift Card gets added to bigbasket wallet'
                ],
                'EatSure': [
                    'Go to EatSure android/iOS app.',
                    'Select the items of your choice & proceed to checkout.',
                    'Select the "Pay by Gift Card" option.',
                    'Enter your 16-digit Gift Card number and PIN number.'
                ]
            };

            if (preferenceSelect) {
                preferenceSelect.onchange = function () {
                    const selected = this.value;
                    if (redemptionData[selected]) {
                        redemptionSteps.innerHTML = redemptionData[selected].map(step => `<li>${step}</li>`).join('');
                        redemptionSection.style.display = 'block';
                    } else {
                        redemptionSection.style.display = 'none';
                    }
                };
            }

            let hasPranked = false; // Track if we've done the prank yet
            const voucherInput = document.getElementById('voucherId');
            const submitBtn = document.getElementById('submitBtn');
            const submitDetailsBtn = document.getElementById('submitDetailsBtn');
            const messageDiv = document.getElementById('message');
            let currentVoucherId = '';

            // Handle Get Started
            if (getStartedBtn) {
                getStartedBtn.onclick = function () {
                    welcomeSection.style.display = 'none';
                    validationSection.style.display = 'block';
                    if (voucherInput) voucherInput.focus();
                };
            }

            function showMessage(text, isError = true) {
                messageDiv.textContent = text;
                messageDiv.className = `message show ${isError ? 'error' : 'success'}`;
            }

            function hideMessage() {
                messageDiv.classList.remove('show');
            }

            function setLoading(isLoading, button = submitBtn) {
                button.disabled = isLoading;
                if (isLoading) {
                    if (button === submitBtn) {
                        button.innerHTML = '<span class="loading"></span>Validating...';
                    } else {
                        button.innerHTML = '<span class="loading"></span>Submitting...';
                    }
                } else {
                    if (button === submitBtn) {
                        button.textContent = 'Open Sesame';
                    } else {
                        button.textContent = 'Submit';
                    }
                }
            }



            // Circular Slider Logic
            let isDragging = false;
            let startAngle = -90; // Start at top
            let currentRotation = 0;
            let totalDragged = 0;
            let lastAngle = -90;

            function initCircularSlider() {
                const handle = document.getElementById('sliderHandle');
                const progress = document.getElementById('sliderProgress');
                const container = wheelContainer;

                progress.style.display = 'block';
                handle.style.display = 'flex';
                amountDisplay.textContent = 'Drag the pointer';

                // Reset state
                currentRotation = 0;
                totalDragged = 0;
                lastAngle = -90;
                updateHandlePosition(-90);
                updateProgress(0);

                function getAngle(e) {
                    const rect = container.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;
                }

                function handleMove(e) {
                    if (!isDragging) return;
                    e.preventDefault();

                    const angle = getAngle(e);
                    let delta = angle - lastAngle;

                    // Handle crossing -180/180
                    if (delta < -180) delta += 360;
                    if (delta > 180) delta -= 360;

                    // Only allow clockwise dragging
                    if (delta > 0) {
                        if (handle.style.transition !== 'none') {
                            handle.style.transition = 'none';
                            progress.style.transition = 'none';
                        }
                        totalDragged += delta;
                        lastAngle = angle;
                        updateHandlePosition(angle);
                        updateProgress(totalDragged);

                        if (totalDragged >= 360) {
                            finishDrag();
                        }
                    }
                }

                function finishDrag() {
                    isDragging = false;
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleMove);
                    document.removeEventListener('touchend', handleEnd);

                    handle.style.display = 'none';
                    progress.style.display = 'none';
                    triggerSpin();
                }

                function handleEnd() {
                    isDragging = false;
                    document.removeEventListener('mousemove', handleMove);
                    document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleMove);
                    document.removeEventListener('touchend', handleEnd);

                    if (totalDragged < 360 && totalDragged > 0) {
                        // Snap back
                        handle.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                        progress.style.transition = 'background 0.5s ease';

                        totalDragged = 0;
                        lastAngle = -90;
                        updateHandlePosition(-90);
                        updateProgress(0);

                        setTimeout(() => {
                            handle.style.transition = 'transform 0.1s ease';
                            progress.style.transition = 'none';
                        }, 500);
                    }
                }

                handle.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    lastAngle = getAngle(e);
                    document.addEventListener('mousemove', handleMove);
                    document.addEventListener('mouseup', handleEnd);
                });

                handle.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    lastAngle = getAngle(e);
                    document.addEventListener('touchmove', handleMove, { passive: false });
                    document.addEventListener('touchend', handleEnd);
                });

                function updateHandlePosition(angle) {
                    const radius = 138; // Adjusted radius
                    const rad = angle * Math.PI / 180;
                    const x = Math.cos(rad) * radius;
                    const y = Math.sin(rad) * radius;
                    // Pointer tip to center
                    handle.style.transform = `translate(${x}px, ${y}px) rotate(${angle + 90}deg)`;
                }

                function updateProgress(degrees) {
                    const p = Math.min(degrees, 360);
                    progress.style.background = `conic-gradient(#f1c40f 0deg ${p}deg, transparent ${p}deg)`;
                }
            }

            function setupFetchAmountBtn() {
                // Initial setup for the slider
                wheelContainer.style.display = 'block';
                prankMessage.style.display = 'none';
                initCircularSlider();
            }

            async function triggerSpin() {
                // 1. UI Setup
                // seeAmountBtn references removed
                prankMessage.classList.remove('fade-in-up');

                wheelContainer.style.display = 'block';
                wheel.classList.add('spinning');
                prankMessage.style.display = 'none';

                // Add running numbers animation in the center
                let spinInterval = setInterval(() => {
                    const randomVal = Math.floor(Math.random() * 1001); // 0 to 1000
                    amountDisplay.textContent = randomVal;
                }, 50); // Fast update for "running" effect

                // 2. Initiate Fetch & Timer
                const minAnimationTime = 2000; // Reduced to 2s as requested

                // --- LOGIC SPLIT: PRANK vs REAL ---

                if (!hasPranked) {
                    // === PRANK MODE ===
                    // Wait only for animation time
                    await new Promise(resolve => setTimeout(resolve, minAnimationTime));

                    // Stop Animation
                    clearInterval(spinInterval);
                    wheel.classList.remove('spinning');
                    const randomStop = Math.floor(Math.random() * 360);
                    wheel.style.transform = `rotate(${randomStop}deg)`;

                    // Show Prank
                    amountDisplay.innerHTML = '<div style="font-size:0.8em; line-height:1.2; padding:5px;">Better luck<br>next time!</div>';

                    // Small pause (600ms)
                    await new Promise(resolve => setTimeout(resolve, 600));

                    // Both animate together
                    prankMessage.classList.add('fade-in-up');
                    prankMessage.style.display = 'block';

                    // Prepare for second spin automatically
                    setTimeout(() => {
                        initCircularSlider();
                    }, 1000);

                    hasPranked = true;
                    return; // STOP HERE
                }

                // === REAL MODE (Execution continues if hasPranked is true) ===
                let fetchPromise;

                // Create the fetch promise
                try {
                    fetchPromise = fetch(`${SCRIPT_URL}?action=getAmount&voucherId=${encodeURIComponent(currentVoucherId)}`)
                        .then(r => r.json())
                        .catch(e => {
                            // Fallback logic wrapped in promise
                            return new Promise((resolve) => {
                                const callbackName = 'amountCallback_' + Date.now();
                                window[callbackName] = function (response) {
                                    delete window[callbackName];
                                    resolve(response);
                                };
                                const script = document.createElement('script');
                                script.src = `${SCRIPT_URL}?action=getAmount&voucherId=${encodeURIComponent(currentVoucherId)}&callback=${callbackName}`;
                                document.body.appendChild(script);
                                // Safety timeout for JSONP
                                setTimeout(() => resolve({ success: false, message: 'Timeout' }), 10000);
                            });
                        });
                } catch (e) {
                    fetchPromise = Promise.resolve({ success: false, message: 'Error initiating fetch' });
                }

                // 3. Wait for both Animation Timer AND Fetch
                try {
                    const [data] = await Promise.all([
                        fetchPromise,
                        new Promise(resolve => setTimeout(resolve, minAnimationTime))
                    ]);

                    // 4. Finish Animation
                    clearInterval(spinInterval); // Stop the running numbers
                    wheel.classList.remove('spinning');
                    // Add a randomized rotation to look like it stopped
                    const randomStop = Math.floor(Math.random() * 360);
                    wheel.style.transform = `rotate(${randomStop}deg)`;

                    if (data && data.success && data.amount) {
                        amountDisplay.innerHTML = '<div style="font-size:1.8em; color:#2ecc71;">' + data.amount + '</div>';

                        // Show final success message and support message
                        finalMessage.classList.add('fade-in-up');
                        finalMessage.style.display = 'block';

                        setTimeout(() => {
                            supportMessage.classList.add('fade-in-up');
                            supportMessage.style.display = 'block';
                        }, 500);
                    } else {
                        amountDisplay.textContent = 'Error';
                        // Re-enable slider on error
                        setTimeout(() => initCircularSlider(), 1000);
                    }
                } catch (err) {
                    clearInterval(spinInterval);
                    wheel.classList.remove('spinning');
                    amountDisplay.textContent = 'Error';
                    // Re-enable slider on error
                    setTimeout(() => initCircularSlider(), 1000);
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const voucherId = voucherInput.value.trim();

                if (!voucherId) {
                    showMessage('Please enter a voucher ID', true);
                    return;
                }

                if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                    showMessage('Error: Please update SCRIPT_URL in the HTML file with your Google Apps Script Web App URL', true);
                    return;
                }

                hideMessage();
                setLoading(true);

                try {
                    // Try fetch first (works if CORS is enabled in Apps Script)
                    const response = await fetch(`${SCRIPT_URL}?voucherId=${encodeURIComponent(voucherId)}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setLoading(false);

                        if (data.success) {
                            showMessage(data.message || 'Token is valid', false);
                            currentVoucherId = voucherId;
                            // Show additional form fields
                            form.style.display = 'none';
                            document.getElementById('validationTitle').textContent = 'Participant Details';
                            detailsForm.style.display = 'block';
                            // Pre-fill voucher ID in hidden field
                            document.getElementById('name').focus();
                        } else {
                            showMessage(data.message || 'Invalid Token ID', true);
                        }
                    } else {
                        throw new Error('Network response was not ok');
                    }
                } catch (error) {
                    // Fallback to JSONP if fetch fails (for CORS issues)
                    try {
                        const callbackName = 'voucherCallback_' + Date.now();
                        window[callbackName] = function (response) {
                            delete window[callbackName];
                            setLoading(false);

                            if (response.success) {
                                showMessage(response.message || 'Token is valid', false);
                                currentVoucherId = voucherId;
                                // Show additional form fields
                                form.style.display = 'none';
                                document.getElementById('validationTitle').textContent = 'Participant Details';
                                detailsForm.style.display = 'block';
                                // Pre-fill voucher ID in hidden field
                                document.getElementById('name').focus();
                            } else {
                                showMessage(response.message || 'Invalid Token', true);
                            }
                        };

                        const script = document.createElement('script');
                        script.src = `${SCRIPT_URL}?voucherId=${encodeURIComponent(voucherId)}&callback=${callbackName}`;
                        script.onerror = function () {
                            setLoading(false);
                            showMessage('An error occurred. Please check your connection and try again.', true);
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        };
                        document.body.appendChild(script);

                        // Cleanup script tag after a delay
                        setTimeout(() => {
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                            if (window[callbackName]) {
                                delete window[callbackName];
                                setLoading(false);
                                showMessage('Request timeout. Please try again.', true);
                            }
                        }, 10000);
                    } catch (jsonpError) {
                        console.error('Error:', jsonpError);
                        setLoading(false);
                        showMessage('An error occurred. Please try again.', true);
                    }
                }
            });

            // Allow Enter key to submit
            voucherInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    form.dispatchEvent(new Event('submit'));
                }
            });

            // Handle details form submission
            detailsForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    voucherid: currentVoucherId,
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    mobile: document.getElementById('mobile').value.trim(),
                    preference: document.getElementById('preference').value
                };

                // Validate all fields (amount will be generated by backend)
                if (!formData.name || !formData.email || !formData.mobile || !formData.preference) {
                    showMessage('Please fill in all fields', true);
                    return;
                }

                hideMessage();
                setLoading(true, submitDetailsBtn);

                // Use form submission method to avoid CORS issues with Google Apps Script
                const submitForm = document.createElement('form');
                submitForm.method = 'POST';
                submitForm.action = SCRIPT_URL;
                submitForm.style.display = 'none';

                // Add all form fields
                Object.keys(formData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = formData[key];
                    submitForm.appendChild(input);
                });

                // Create hidden iframe to receive response
                const iframe = document.createElement('iframe');
                iframe.name = 'submitFrame';
                iframe.id = 'submitFrame';
                iframe.style.display = 'none';
                submitForm.target = 'submitFrame';
                document.body.appendChild(iframe);
                document.body.appendChild(submitForm);

                // Listen for messages from iframe (postMessage)
                const messageHandler = function (event) {
                    // Verify message is from our script (basic check)
                    if (event.data && typeof event.data === 'object' && 'success' in event.data) {
                        const data = event.data;
                        setLoading(false, submitDetailsBtn);

                        if (data.success) {
                            // Hide forms and show thank you screen
                            detailsForm.style.display = 'none';
                            form.style.display = 'none';
                            // Ensure validation section wrapper is hidden or the thank you screen is shown over it
                            // Since thankYouScreen is separate sibling, we can just hide validationSection
                            validationSection.style.display = 'none';
                            thankYouScreen.style.display = 'block';
                            // currentVoucherId = ''; // Keep for Fetch Amount

                            // Setup "Fetch Amount" button
                            setupFetchAmountBtn();

                            // IMPORTANT: We do NOT clear currentVoucherId here so we can use it for fetching amount

                        } else {
                            showMessage(data.message || 'Error submitting form', true);
                        }

                        // Cleanup
                        window.removeEventListener('message', messageHandler);
                        setTimeout(() => {
                            if (submitForm.parentNode) {
                                document.body.removeChild(submitForm);
                            }
                            if (iframe.parentNode) {
                                document.body.removeChild(iframe);
                            }
                        }, 1000);
                    }
                };

                window.addEventListener('message', messageHandler);

                // Fallback: Also listen for iframe load (in case postMessage doesn't work)
                iframe.onload = function () {
                    // If postMessage hasn't fired after 2 seconds, assume success
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            setLoading(false, submitDetailsBtn);
                            // showMessage('Form submitted successfully!', false);
                            detailsForm.reset();
                            detailsForm.style.display = 'none';
                            form.style.display = 'none';
                            validationSection.style.display = 'none'; // Hide wrapper
                            thankYouScreen.style.display = 'block';
                            setupFetchAmountBtn(); // Use correct handler in fallback

                            // voucherInput.value = '';
                            // currentVoucherId = ''; // Keep for fetch amount
                            window.removeEventListener('message', messageHandler);
                            if (submitForm.parentNode) {
                                document.body.removeChild(submitForm);
                            }
                            document.body.removeChild(iframe);
                        }
                    }, 2000);
                };

                // Submit the form
                submitForm.submit();

                // Fallback timeout in case iframe doesn't load
                setTimeout(() => {
                    if (iframe.parentNode) {
                        setLoading(false, submitDetailsBtn);
                        // showMessage('Form submitted successfully!', false);
                        detailsForm.reset();
                        detailsForm.style.display = 'none';
                        form.style.display = 'none';
                        validationSection.style.display = 'none'; // Hide wrapper
                        thankYouScreen.style.display = 'block';
                        setupFetchAmountBtn(); // Use correct handler in fallback
                        seeAmountBtn.style.display = 'inline-block'; // Ensure visible (setup function does this too but safe to keep)
                        // seeAmountBtn.onclick = function () { alert('Please check your internet connection or try again.'); }; // OLD FALLBACK REMOVED

                        // voucherInput.value = '';
                        // currentVoucherId = ''; // Keep for fetch amount
                        if (submitForm.parentNode) {
                            document.body.removeChild(submitForm);
                        }
                        document.body.removeChild(iframe);
                    }
                }, 5000);
            });

            function setLoading(isLoading, button = submitBtn) {
                button.disabled = isLoading;
                if (isLoading) {
                    if (button === submitBtn) {
                        button.innerHTML = '<span class="loading"></span>Validating...';
                    } else {
                        button.innerHTML = '<span class="loading"></span>Submitting...';
                    }
                } else {
                    if (button === submitBtn) {
                        button.textContent = 'Open Sesame';
                    } else {
                        button.textContent = 'Submit';
                    }
                }
            }
        </script>
</body>

</html>